const LOREM_IPSUM_TEXT = `Lorem ipsum dolor sit amet, consectetur adipiscing elit. Mauris sed arcu vel nunc dictum bibendum. In sed leo sit amet est efficitur feugiat vitae ac elit. Proin condimentum ultrices mi sit amet tincidunt. Ut id magna vel nulla convallis porttitor. Fusce semper tellus nibh, sit amet gravida ipsum dapibus sit amet. Nam blandit gravida hendrerit. Proin accumsan, tortor vitae ultricies consectetur, ligula risus sollicitudin ex, facilisis iaculis nulla enim ac purus. Duis egestas dignissim augue, ac ultrices lectus egestas eu. Aliquam vel egestas nibh, et posuere lectus. Aliquam in nunc ante. Nam sed neque risus. Nulla quis risus felis. Mauris dictum neque vel tellus eleifend pulvinar. Proin auctor urna efficitur quam posuere ullamcorper. Praesent accumsan imperdiet auctor.

Nulla ultricies sed massa non dapibus. Proin pretium aliquam nibh, non volutpat nunc tristique ac. Mauris velit justo, tempor ut faucibus a, sagittis ac orci. Morbi molestie lorem a libero consectetur, quis sollicitudin ligula lacinia. Cras id magna augue. Quisque ornare aliquet hendrerit. Suspendisse vel interdum magna. Nunc pharetra dui ut gravida sollicitudin. Nam enim sapien, sodales sed venenatis quis, aliquam vel nibh. Suspendisse nec massa quis mi euismod consectetur. Vestibulum tempor erat finibus sem suscipit luctus. Donec convallis mi magna, at viverra augue facilisis ut. Fusce a iaculis lacus. Nulla id eleifend quam, nec dignissim leo. Donec pellentesque nunc non metus elementum feugiat.

Curabitur sit amet iaculis quam. In sit amet massa id nulla egestas condimentum in a ante. Pellentesque sit amet lacus eget lorem varius condimentum quis pellentesque neque. Etiam non sapien vitae purus volutpat ultricies non eu metus. Aliquam non porttitor nulla. Duis tincidunt enim quis purus congue, eu ornare ipsum venenatis. Mauris ullamcorper turpis sit amet ultricies blandit. Ut consequat nibh sed dolor dapibus, a malesuada ante iaculis. Nam pharetra turpis sapien, nec pellentesque mauris faucibus in. Nam pulvinar, massa non condimentum euismod, augue augue congue dui, vitae porta ante nibh ac dolor. Praesent et malesuada velit. Aenean vel imperdiet ante. Vivamus scelerisque, nisl auctor malesuada volutpat, purus felis blandit nibh, nec lobortis felis leo non diam. Vivamus at lacus urna. Vivamus sit amet elit mattis, rhoncus erat at, mattis enim. Pellentesque arcu diam, congue vitae felis id, vestibulum vestibulum tellus.

Curabitur consectetur justo in enim malesuada, in varius ipsum vehicula. Sed scelerisque, felis ut mattis ornare, est odio interdum arcu, eu ultrices ipsum tortor et arcu. Aliquam erat volutpat. Praesent sit amet posuere est, in aliquam metus. Sed bibendum hendrerit lacus vitae luctus. Vivamus sem risus, fringilla ut aliquet ut, ullamcorper sed elit. Phasellus at elementum nisi. Pellentesque gravida, turpis id molestie lacinia, elit justo consectetur neque, sit amet pretium dolor purus quis enim. Nunc non purus sit amet enim finibus dignissim. Donec lobortis, nibh in viverra varius, lectus lorem facilisis est, vitae fermentum ex dui non justo. Vivamus porta ullamcorper accumsan. Nulla feugiat ipsum a nibh suscipit, eu convallis purus feugiat. Pellentesque suscipit odio ligula, tincidunt blandit sem tincidunt vel. Cras nec finibus felis.

Sed pharetra nibh risus, a placerat urna eleifend nec. Nam sit amet lacus eu sapien pharetra sollicitudin. Sed ultricies viverra pharetra. Nulla bibendum sollicitudin felis a cursus. Quisque vel viverra metus. Nunc laoreet pulvinar sollicitudin. Cras dapibus lobortis magna, vitae iaculis metus pharetra vitae.

Phasellus ante quam, efficitur eu ante eu, pharetra suscipit nisl. Aliquam porttitor, risus ac sodales dignissim, leo nisi bibendum leo, sed imperdiet purus massa vitae turpis. Quisque at nisl lacus. Aenean elementum ut ipsum at suscipit. Donec in nunc sit amet neque pulvinar auctor. Suspendisse non vulputate nisl. Morbi faucibus aliquet nulla, commodo consectetur est tempor et.

Vestibulum semper, lectus et dignissim pretium, nulla augue interdum nulla, ac consequat purus orci eleifend enim. Donec laoreet mauris consequat neque scelerisque faucibus. Orci varius natoque penatibus et magnis dis parturient montes, nascetur ridiculus mus. Etiam efficitur ex a cursus laoreet. Praesent et ante ac elit pellentesque ullamcorper. Etiam vulputate maximus nunc a accumsan. Vestibulum aliquam elit eu dolor malesuada mattis.

Fusce elementum tortor a leo mollis, eget pretium quam cursus. Quisque sed odio sem. Aenean ac dolor pretium, consectetur nunc vel, sollicitudin est. Phasellus facilisis finibus augue sed vulputate. Cras ornare orci dolor, eget laoreet lacus tempus nec. Ut dapibus libero viverra commodo faucibus. Sed convallis auctor magna vitae pellentesque. Nam tempor quis dolor eget accumsan. Suspendisse potenti. Nunc facilisis lorem enim, non ullamcorper nisl mattis ac. Nam sed hendrerit diam. Cras sed gravida tellus.

Quisque vel lacus a orci maximus efficitur. Praesent volutpat sodales massa a posuere. In blandit, purus eget viverra mollis, elit justo suscipit elit, et rhoncus est magna sit amet lorem. Duis odio metus, euismod eget ornare dignissim, convallis vitae massa. Donec scelerisque dui a eros bibendum, et dapibus quam fringilla. Fusce ac cursus ante, vel cursus libero. Maecenas ut pretium elit. Maecenas dapibus suscipit convallis. Aenean pellentesque porttitor maximus. Etiam varius vehicula leo ut volutpat. Aliquam imperdiet cursus orci et accumsan. Proin et vestibulum quam. Nulla eget libero vestibulum diam venenatis faucibus quis at dui. Nam faucibus ornare dolor in molestie. Integer rhoncus est ante, viverra tempor turpis sodales nec.

Suspendisse cursus maximus felis. Aenean finibus ultrices purus id vestibulum. Donec ut orci tempus, ornare orci non, tempus libero. Cras rutrum quis urna et posuere. Pellentesque aliquet nunc massa, ac ullamcorper odio maximus ut. Phasellus felis nisi, gravida eu commodo vitae, laoreet at neque. Duis consequat in dolor a venenatis. Sed ullamcorper vestibulum magna ut venenatis. Nunc blandit arcu a scelerisque pharetra. Vivamus pellentesque urna eget viverra rhoncus. Nunc sit amet ornare mauris.

Sed cursus, risus sit amet ornare fringilla, nibh erat ullamcorper purus, et auctor dui enim a velit. Etiam a mollis nisl, in semper enim. Maecenas nibh nulla, tincidunt ut consequat eget, eleifend ac lacus. Integer sit amet elit dictum, convallis elit non, posuere dolor. Ut eu erat ut diam dapibus posuere. Cras pulvinar pharetra molestie. Sed quis lectus aliquet, accumsan lectus non, ullamcorper risus. Mauris placerat scelerisque leo ut posuere. Nullam faucibus vehicula nibh, vel congue arcu pellentesque mollis. Donec in vehicula nisi. In lobortis luctus libero at condimentum. Nulla blandit scelerisque mauris.

Aliquam viverra luctus nisl, nec aliquam nibh semper sed. Donec semper, dui ut facilisis semper, eros ligula vulputate ante, quis mollis purus mauris et risus. Nam maximus odio eget fringilla dignissim. Quisque a tincidunt urna, ac sodales massa. Quisque non ornare massa, et aliquam nunc. Fusce nec posuere leo. Integer pellentesque nisi ac enim mattis, vel pretium orci sagittis.

Aliquam ante dui, fermentum interdum odio sit amet, efficitur ultrices ligula. Phasellus vulputate ligula id ligula volutpat congue. Donec sit amet feugiat nulla, a gravida mauris. Quisque consequat, purus rhoncus gravida interdum, ex lectus tristique sem, eu tincidunt sem nulla at felis. Etiam suscipit nec felis non viverra. Praesent gravida ipsum quis porttitor lobortis. Aliquam vulputate malesuada ligula, ac luctus lorem vulputate vel. Nam turpis sem, fringilla non diam eu, faucibus varius tellus. Pellentesque sed tortor enim. Morbi viverra, purus vitae sollicitudin finibus, lorem mi imperdiet odio, gravida ullamcorper massa justo efficitur sapien. Suspendisse vitae ipsum lorem. Nulla facilisi. Vestibulum id eros purus.

Etiam pretium hendrerit tortor, eu eleifend sem consequat ultricies. Vivamus cursus magna ex, at consectetur mi tempor nec. Cras fringilla et odio at euismod. Sed enim nulla, dictum quis suscipit ut, venenatis vel ipsum. Cras in varius orci, ac pretium lacus. Aenean nec nulla bibendum, tincidunt erat id, faucibus lacus. Proin sagittis metus non imperdiet facilisis. Vivamus non nibh tempor, tempus justo non, volutpat mauris. In maximus tincidunt arcu. Nullam ultricies, urna a ultricies vehicula, purus arcu ultricies neque, eu finibus nulla mauris congue ligula. Aenean mattis dui vitae ante tempus volutpat.

Sed mattis dolor at lectus efficitur pulvinar. Suspendisse et orci ullamcorper massa aliquet porta. Nam placerat condimentum arcu at vestibulum. Aliquam maximus at eros vel finibus. Sed et massa sem. Sed commodo consequat ex at malesuada. Nulla ultricies tincidunt sapien, quis semper nisl tincidunt euismod. Curabitur euismod lorem a ex lobortis molestie. Praesent id massa condimentum ligula aliquet condimentum faucibus sed velit. Cras vel hendrerit mi, id pulvinar sem. Nulla a elit eu mi suscipit mattis id sit amet nulla. Nulla facilisi. Vestibulum eleifend eros tortor, fringilla ullamcorper odio feugiat sed.

Aliquam et consectetur ante. Vivamus aliquet neque nec congue tincidunt. Etiam mattis porta viverra. Integer aliquam mauris id turpis mollis vulputate. Mauris et tempor lorem. Cras sed ullamcorper neque. Morbi sem nulla, molestie sed enim id, facilisis venenatis urna. Cras fringilla auctor euismod. Aliquam laoreet ex eget fermentum rhoncus. Suspendisse tempor turpis sit amet urna venenatis, id dapibus purus laoreet. Nulla scelerisque sapien augue, vitae euismod arcu cursus sit amet. Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nam nec elementum nisl, vitae tincidunt tellus. Vivamus ac enim iaculis, hendrerit risus sit amet, lobortis diam. Nullam porta est aliquam nisi elementum placerat. Phasellus pellentesque, ligula quis tincidunt hendrerit, ipsum dolor tincidunt metus, at scelerisque libero ante vitae risus.

Integer quis ipsum eu risus hendrerit porta nec eget nisi. Praesent consectetur commodo sem, a posuere magna euismod nec. Aenean non ornare sapien. Cras in ultricies massa. Etiam tortor ante, maximus vitae rhoncus non, vehicula in erat.`;

const LOG_LEVELS = ['info', 'error', 'warning', 'success'];

const getRandomLogLevel = () => LOG_LEVELS[Math.floor(Math.random() * LOG_LEVELS.length)];

const getRandomLog = () => {
  const randomIndex = Math.floor(Math.random() * LOREM_IPSUM_TEXT.length - 50);
  const logLength = 50 + Math.floor(Math.random() * 700);
  return LOREM_IPSUM_TEXT.slice(randomIndex, randomIndex + logLength);
};

export class MimicLogs {
  /**
   *
   * @param {number} startTs
   * @param {number} endTs
   * @param {number} limit
   * @returns {Promise<{timestamp: number; message: string}[]>}
   */
  static fetchPreviousLogs({ startTs, endTs, limit }) {
    return new Promise((resolve) => {
      const delay = 250 + Math.random() * 2750;
      const randomPastTs = Math.max(
        endTs - (600000 + Math.random() * 1000 * 60 * 60 * 6),
        startTs
      );

      const gap = Math.floor((endTs - randomPastTs) / limit);
      const logs = Array.from({ length: limit }).map((_, i) => ({
        timestamp: endTs - (i ? i * gap : 1),
        message: getRandomLog(),
        level: getRandomLogLevel(),
      }));
      setTimeout(() => resolve(logs), delay);
    });
  }

  static subscribeToLiveLogs(callback) {
    let timeout;
    const generateNextLog = () => {
      const nextLog = { timestamp: Date.now(), message: getRandomLog() };
      callback(nextLog);
      timeout = setTimeout(generateNextLog, 10 + Math.random() * 1990);
    };
    timeout = setTimeout(generateNextLog, 10 + Math.random() * 1990);

    return () => clearInterval(timeout);
  }
}

const timeWindowsList = [
  60 * 5,
  60 * 15,
  60 * 30,
  60 * 60,
  60 * 60 * 3,
  60 * 60 * 6,
  60 * 60 * 12,
  60 * 60 * 24,
  60 * 60 * 24 * 2,
  60 * 60 * 24 * 7,
  60 * 60 * 24 * 30,
];
const timeWindowToStepSizeMap = {
  [60 * 5]: 1,
  [60 * 15]: 5,
  [60 * 30]: 15,
  [60 * 60]: 30,
  [60 * 60 * 3]: 60,
  [60 * 60 * 6]: 300,
  [60 * 60 * 12]: 600,
  [60 * 60 * 24]: 900,
  [60 * 60 * 24 * 2]: 1800,
  [60 * 60 * 24 * 7]: 3600,
  [60 * 60 * 24 * 30]: 21600,
};
const getStepSize = (startTs, endTs) => {
  const timeDiff = endTs - startTs;
  const matched =
    timeWindowsList.find((v) => v * 1000 > timeDiff) ||
    timeWindowsList[timeWindowsList.length - 1];
  const stepSize = timeWindowToStepSizeMap[matched];

  return stepSize;
};
const normaliseTime = (timestamp, step) => {
  const utcOffsetSeconds = new Date().getTimezoneOffset() * 60;
  return timestamp - ((timestamp - utcOffsetSeconds * 1000) % (step * 1000));
};

const populateDataValues = (startTs, endTs, stepSize, min = 0, max = 100) => {
  const dataValues = [];
  for (let i = startTs; i <= endTs; i += stepSize * 1000) {
    dataValues.push({
      timestamp: i,
      value: min + Math.floor(Math.random() * (max - min) * 100) / 100,
    });
  }
  return dataValues;
};

export class MimicMetrics {
  static fetchMetrics({ startTs, endTs }) {
    const stepSize = getStepSize(startTs, endTs);
    const normalisedStartTs = normaliseTime(startTs, stepSize);
    const normalisedEndTs = normaliseTime(endTs, stepSize);

    const getGraph = (name, linesConfig) => ({
      name,
      graphLines: linesConfig.map(([name, min, max]) => ({
        name,
        values: populateDataValues(
          normalisedStartTs,
          normalisedEndTs,
          stepSize,
          min,
          max
        ),
      })),
    });
    const getProportionateMinMax = (min, max, newPeak) => [
      (min * newPeak) / 100,
      (max * newPeak) / 100,
    ];
    return new Promise((resolve) => {
      const delay = 250 + Math.random() * 2750;
      setTimeout(
        () =>
          resolve([
            getGraph("CPU Usage", [
              ["Limits", 80, 100],
              ["Requested", 40, 85],
              ["Used", 10, 60],
            ]),
            getGraph("Memory Usage", [
              ["Limits", ...getProportionateMinMax(80, 100, 32768)],
              ["Requested", ...getProportionateMinMax(40, 85, 32768)],
              ["Used", ...getProportionateMinMax(10, 60, 32768)],
            ]),
            getGraph("Network Usage", [
              ["Limits", ...getProportionateMinMax(80, 100, 512)],
              ["Requested", ...getProportionateMinMax(40, 85, 512)],
              ["Used", ...getProportionateMinMax(10, 60, 512)],
            ]),
            getGraph("Disk IOPS", [
              ["Read", ...getProportionateMinMax(80, 100, 25)],
              ["Write", ...getProportionateMinMax(10, 60, 25)],
            ]),
          ]),
        delay
      );
    });
  }
}
